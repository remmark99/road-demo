import { openai } from "@ai-sdk/openai"
import { convertToModelMessages, streamText, UIMessage, stepCountIs, jsonSchema } from "ai"
import { Client } from "@modelcontextprotocol/sdk/client/index.js"
import { SSEClientTransport } from "@modelcontextprotocol/sdk/client/sse.js"

const MCP_SERVER_URL = process.env.MCP_SERVER_URL || "http://89.124.74.27:8000/sse"

// –¢–∞–π–º–∞—É—Ç—ã (–≤ –º—Å)
const MCP_CONNECT_TIMEOUT = 15000    // 15 —Å–µ–∫ –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
const MCP_PING_TIMEOUT = 5000        // 5 —Å–µ–∫ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
const MCP_LIST_TOOLS_TIMEOUT = 10000 // 10 —Å–µ–∫ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
const MCP_CALL_TOOL_TIMEOUT = 120000 // 120 —Å–µ–∫ –Ω–∞ –≤—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (—Å–ª–æ–∂–Ω—ã–µ SQL)

// Cache the MCP client
let mcpClient: Client | null = null
let mcpConnected = false

// üîß –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–∞—É—Ç–∞ –∫ Promise
function withTimeout<T>(promise: Promise<T>, ms: number, errorMessage?: string): Promise<T> {
    return Promise.race([
        promise,
        new Promise<T>((_, reject) =>
            setTimeout(() => reject(new Error(errorMessage || `Timeout after ${ms}ms`)), ms)
        )
    ]);
}

// üîå –°–±—Ä–æ—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
function resetConnection() {
    console.log("üîÑ Resetting MCP connection...");
    mcpConnected = false;
    mcpClient = null;
}

async function connectMCP(): Promise<Client | null> {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –µ—â—ë –∂–∏–≤–æ
    if (mcpConnected && mcpClient) {
        try {
            // Ping ‚Äî –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å —Ç–∞–π–º–∞—É—Ç–æ–º
            await withTimeout(
                mcpClient.listTools(),
                MCP_PING_TIMEOUT,
                "MCP ping timeout - connection stale"
            );
            return mcpClient;
        } catch (error) {
            console.warn("‚ö†Ô∏è MCP connection stale, reconnecting...", error);
            resetConnection();
        }
    }

    try {
        console.log("üîå Connecting to MCP server:", MCP_SERVER_URL);
        
        const transport = new SSEClientTransport(new URL(MCP_SERVER_URL), {
            requestInit: {
                headers: {
                    Authorization: `Bearer my_secure_token_123`,
                },
            }
        })
        
        const newClient = new Client(
            { name: "surgut-roads-client", version: "1.0.0" },
            { capabilities: {} }
        )

        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è —Å —Ç–∞–π–º–∞—É—Ç–æ–º
        await withTimeout(
            newClient.connect(transport),
            MCP_CONNECT_TIMEOUT,
            "MCP connection timeout"
        );
        
        mcpClient = newClient;
        mcpConnected = true;
        console.log("‚úÖ Connected to MCP server");
        return mcpClient;
    } catch (error) {
        console.error("‚ùå Failed to connect to MCP server:", error);
        resetConnection();
        return null;
    }
}

export async function POST(req: Request) {
    const { messages }: { messages: UIMessage[] } = await req.json();

    const client = await connectMCP();

    let tools: Record<string, any> = {};

    if (client) {
        try {
            const listToolsResult = await withTimeout(
                client.listTools(),
                MCP_LIST_TOOLS_TIMEOUT,
                "listTools timeout"
            ) as { tools: Array<{ name: string; description?: string; inputSchema?: any }> };
            const mcpTools = listToolsResult.tools;

            for (const mcpTool of mcpTools) {
                const name = mcpTool.name;
                const description = mcpTool.description || "";

                // –ë–µ—Ä—ë–º inputSchema, –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ ‚Äî –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç
                const schema = mcpTool.inputSchema;

                let jsonSchemaProps;
                let jsonSchemaRequired;

                if (!schema || schema.type !== "object") {
                    // –ï—Å–ª–∏ schema –Ω–µ—Ç –∏–ª–∏ –Ω–µ object, —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                    jsonSchemaProps = {};
                    jsonSchemaRequired = [];
                    console.warn(`[tools] Invalid schema for tool '${name}': using empty object schema`, schema);
                } else {
                    jsonSchemaProps = schema.properties || {};
                    jsonSchemaRequired = Array.isArray(schema.required) ? schema.required : [];
                }

                // –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–µ—Ä–µ–¥–∞—ë–º –≤ jsonSchema –≤–∞–ª–∏–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç
                tools[name] = {
                    description,
                    inputSchema: jsonSchema({
                        type: "object",
                        properties: jsonSchemaProps,
                        required: jsonSchemaRequired,
                    }),
                    execute: async (args: any) => {
                        console.log(`Executing tool ${name} with args:`, args);
                        try {
                            const result = await withTimeout(
                                client.callTool({
                                    name,
                                    arguments: args,
                                }),
                                MCP_CALL_TOOL_TIMEOUT,
                                `Tool '${name}' timeout after ${MCP_CALL_TOOL_TIMEOUT}ms`
                            );
                            return result;
                        } catch (error) {
                            console.error(`Error calling tool ${name}:`, error);
                            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                            resetConnection();
                            throw error;
                        }
                    },
                };
            }
        } catch (e) {
            console.error("Failed to list MCP tools:", e);
        }
    }

    const result = streamText({
        model: openai("gpt-5"),
        system: `–¢—ã - AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Ä–æ–≥ –∏ —Ç—Ä–∞—Ñ–∏–∫–∞ –≤ –≥–æ—Ä–æ–¥–µ –°—É—Ä–≥—É—Ç. 
–¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≥–æ—Ä–æ–¥–∞ –≤ –ø—Ä–∏–Ω—è—Ç–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏—Ö —Ä–µ—à–µ–Ω–∏–π. 
–û—Ç–≤–µ—á–∞–π –Ω–∞ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω–æ–º –∏ –ø–æ–Ω—è—Ç–Ω–æ–º —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –¢—ã –æ–±—â–∞–µ—à—å—Å—è —Å —É–≤–∞–∂–∞–µ–º—ã–º–∏ –ª—é–¥—å–º–∏.
–ë—É–¥—å –ø–æ–ª–µ–∑–Ω—ã–º –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º.

## –ì–õ–û–°–°–ê–†–ò–ô –¢–ï–†–ú–ò–ù–û–í

–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç—É —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é –ø—Ä–∏ –æ–±—â–µ–Ω–∏–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏:

**–ò–ù–¶–ò–î–ï–ù–¢** ‚Äî –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º–æ–π —Ñ–∞–∫—Ç –Ω–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Ä–æ–≥–∏ –∏–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–æ—Ä–æ–∂–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã. –ò–Ω—Ü–∏–¥–µ–Ω—Ç –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ —Å–∏—Å—Ç–µ–º–∞ –≤–ø–µ—Ä–≤—ã–µ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É.
–ü—Ä–∏–º–µ—Ä—ã: —Å–Ω–µ–∂–Ω–∞—è –∫–∞—à–∞ –Ω–∞ –ø—Ä–æ–µ–∑–∂–µ–π —á–∞—Å—Ç–∏, –ø–æ–¥—Ç–æ–ø–ª–µ–Ω–∏–µ –¥–æ—Ä–æ–≥–∏, –æ—Ç–∫—Ä—ã—Ç—ã–π –ª—é–∫, –ø–æ–∫–æ—Å–∏–≤—à–∏–π—Å—è –¥–æ—Ä–æ–∂–Ω—ã–π –∑–Ω–∞–∫, –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ.

**–ù–ê–†–£–®–ï–ù–ò–ï** ‚Äî —ç—Ç–æ –ò–Ω—Ü–∏–¥–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –±—ã–ª —É—Å—Ç—Ä–∞–Ω—ë–Ω –≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π —Å—Ä–æ–∫. –ü—Ä–æ—â–µ –≥–æ–≤–æ—Ä—è: –ò–Ω—Ü–∏–¥–µ–Ω—Ç ‚Äî —ç—Ç–æ —Å–∞–º–∞ –ø—Ä–æ–±–ª–µ–º–∞, –ù–∞—Ä—É—à–µ–Ω–∏–µ ‚Äî —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞, –∫–æ—Ç–æ—Ä–∞—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ. –ù–∞—Ä—É—à–µ–Ω–∏—è —è–≤–ª—è—é—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç—ã –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤.

**–¢–ò–ü –†–ê–ë–û–¢** ‚Äî –∫–∞–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è —Ç—Ä–µ–±—É—é—Ç—Å—è –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã:
- –£–ë–û–†–ö–ê: –æ—á–∏—Å—Ç–∫–∞ –∏ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –¥–æ—Ä–æ–≥–∏ –≤ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—Å–Ω–µ–∂–Ω–∞—è –∫–∞—à–∞, —Å–Ω–µ–∂–Ω—ã–µ –≤–∞–ª—ã –∏ —Å–Ω–µ–∂–Ω—ã–µ –∫—É—á–∏, –≥—Ä—è–∑—å –Ω–∞ –¥–æ—Ä–æ–≥–∞—Ö, –ø–æ–¥—Ç–æ–ø–ª–µ–Ω–∏—è)
- –†–ï–ú–û–ù–¢: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ª–∏ –∑–∞–º–µ–Ω–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–æ—Ç–∫—Ä—ã—Ç—ã–µ –ª—é–∫–∏, –¥–æ—Ä–æ–∂–Ω—ã–µ –∑–Ω–∞–∫–∏, –æ—Å–≤–µ—â–µ–Ω–∏–µ, —Ä–∞–∑–º–µ—Ç–∫–∞)

**–¢–ò–ü –ò–ù–¶–ò–î–ï–ù–¢–ê** ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–∏–¥ –ø—Ä–æ–±–ª–µ–º—ã: —Å–Ω–µ–∂–Ω–∞—è –∫–∞—à–∞, —Å–Ω–µ–∂–Ω—ã–π –≤–∞–ª, —Å–Ω–µ–∂–Ω–∞—è –∫—É—á–∞, –ø–æ–¥—Ç–æ–ø–ª–µ–Ω–∏–µ, –≥—Ä—è–∑—å –Ω–∞ –¥–æ—Ä–æ–≥–µ, –æ—Ç–∫—Ä—ã—Ç—ã–π –ª—é–∫, –ø–æ–∫–æ—Å–∏–≤—à–∏–π—Å—è –∑–Ω–∞–∫, –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ.

**–í–†–ï–ú–Ø –†–ï–ê–ö–¶–ò–ò** ‚Äî –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç –º–æ–º–µ–Ω—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞ –¥–æ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç –ø–æ –µ–≥–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é. –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å –æ—Ç—Ä–∞–∂–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ –ø–æ–¥—Ä—è–¥—á–∏–∫ –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª –Ω–∞ –ø—Ä–æ–±–ª–µ–º—É.

**–ù–û–†–ú–ê–¢–ò–í–´ –í–†–ï–ú–ï–ù–ò –†–ï–ê–ö–¶–ò–ò (SLA –ü–û –†–ï–ê–ö–¶–ò–ò)**:
- –£–±–æ—Ä–∫–∞: –Ω–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 12 —á–∞—Å–æ–≤
- –†–µ–º–æ–Ω—Ç: –Ω–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤

**–í–†–ï–ú–Ø –£–°–¢–†–ê–ù–ï–ù–ò–Ø** ‚Äî –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç –º–æ–º–µ–Ω—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞ –¥–æ –ø–æ–ª–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.

**–ö–û–ì–î–ê –ò–ù–¶–ò–î–ï–ù–¢ –°–¢–ê–ù–û–í–ò–¢–°–Ø –ù–ê–†–£–®–ï–ù–ò–ï–ú (SLA –ü–û –£–°–¢–†–ê–ù–ï–ù–ò–Æ)**:
- –£–±–æ—Ä–∫–∞: –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 18 —á–∞—Å–æ–≤
- –û—Ç–∫—Ä—ã—Ç—ã–π –ª—é–∫: –Ω–µ –∑–∞–∫—Ä—ã—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 8 —á–∞—Å–æ–≤
- –î–æ—Ä–æ–∂–Ω—ã–µ –∑–Ω–∞–∫–∏, –æ—Å–≤–µ—â–µ–Ω–∏–µ, —Ä–∞–∑–º–µ—Ç–∫–∞: –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è 100 —á–∞—Å–æ–≤ –∏ –±–æ–ª–µ–µ

**–ü–†–û–°–†–û–ß–ö–ê** ‚Äî —Å–∏—Ç—É–∞—Ü–∏—è, –∫–æ–≥–¥–∞ –ø–æ–¥—Ä—è–¥—á–∏–∫ —Å–ª–∏—à–∫–æ–º –ø–æ–∑–¥–Ω–æ –Ω–∞—á–∞–ª —Ä–∞–±–æ—Ç—ã (–ø—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è —Ä–µ–∞–∫—Ü–∏–∏) –∏/–∏–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ —É—Å—Ç—Ä–∞–Ω—è–ª –ø—Ä–æ–±–ª–µ–º—É (–ø—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è).

**–ü–†–û–¶–ï–ù–¢ –ü–†–û–°–†–û–ß–ï–ù–ù–´–• –ò–ù–¶–ò–î–ï–ù–¢–û–í** ‚Äî –¥–æ–ª—è –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –±—ã–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω—ã –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å—Ä–æ–∫–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è. –ö–ª—é—á–µ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏.

**–ü–û–î–†–Ø–î–ß–ò–ö** ‚Äî –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ—Ä–æ–∂–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Å–≤–æ–µ–π –∑–æ–Ω—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏.

**–ó–û–ù–ê –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–ò** ‚Äî —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –≥–æ—Ä–æ–¥–∞, –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–∞—è –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–º.

**–ú–ê–¢–†–ò–¶–ê –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–ò** ‚Äî —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –ø–æ–∫–∞–∑—ã–≤–∞—é—â–∏–π –º–∞—Å—à—Ç–∞–± –∑–æ–Ω—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ–¥—Ä—è–¥—á–∏–∫–∞ –∏ –∫–∞—á–µ—Å—Ç–≤–æ –µ–≥–æ —Ä–∞–±–æ—Ç—ã.

## –ü–†–ê–í–ò–õ–ê –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø

–í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –≤–º–µ—Å—Ç–æ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∂–∞—Ä–≥–æ–Ω–∞:
- p95 ‚Üí 95-–π –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å
- p90 ‚Üí 90-–π –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å
- p50 ‚Üí –º–µ–¥–∏–∞–Ω–∞ (50-–π –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å)
- avg, mean ‚Üí —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
- std, œÉ ‚Üí —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
- SLA ‚Üí –Ω–æ—Ä–º–∞—Ç–∏–≤—ã / —Ä–µ–≥–ª–∞–º–µ–Ω—Ç
- –ù–µ –ø–∏—à–∏ SQL —Ç–µ—Ä–º–∏–Ω—ã, –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ ‚Äî —Ç–≤–æ–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω—Ü—ã, –Ω–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã.

## –ü–û–õ–ò–¢–ò–ö–ê –û–¢–í–õ–ï–ß–Å–ù–ù–´–• –¢–ï–ú

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞—ë—Ç –≤–æ–ø—Ä–æ—Å, –ù–ï —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –¥–æ—Ä–æ–≥–∞–º–∏, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º, –ø–æ–¥—Ä—è–¥—á–∏–∫–∞–º–∏, –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞–º–∏ –∏–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –≥–æ—Ä–æ–¥–æ–º ‚Äî –ù–ï –æ—Ç–≤–µ—á–∞–π —Å—Ä–∞–∑—É.

–í–µ–∂–ª–∏–≤–æ —É—Ç–æ—á–Ω–∏: "–Ø –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –¥–æ—Ä–æ–∂–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ –≥–æ—Ä–æ–¥–∞ –°—É—Ä–≥—É—Ç. –ú–æ—è –æ—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –≤ –∞–Ω–∞–ª–∏–∑–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Ä–æ–≥ –∏ —Ä–∞–±–æ—Ç—ã –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤. –ï—Å–ª–∏ –≤—ã –≤—Å—ë –∂–µ —Ö–æ—Ç–∏—Ç–µ –æ–±—Å—É–¥–∏—Ç—å –¥—Ä—É–≥—É—é —Ç–µ–º—É, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —ç—Ç–æ, –∏ —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –ø–æ–º–æ—á—å."

–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –º–æ–∂–µ—à—å –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –æ—Ç–≤–ª–µ—á—ë–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å.

## –î–û–°–¢–£–ü–ù–´–ï –ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–´

–£ —Ç–µ–±—è –µ—Å—Ç—å —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö –ø—Ä–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö:

| –¢–µ–º–∞ –≤–æ–ø—Ä–æ—Å–∞ | –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------------|-----------|----------|
| –ó–∞–¥–µ—Ä–∂–∫–∏ —Ä–µ–∞–∫—Ü–∏–∏ –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤ | analyze_reaction_tails | –•–≤–æ—Å—Ç—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Ä–µ–∞–∫—Ü–∏–∏ (95-–π –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å) |
| –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–±–ª–µ–º, —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è | rate_problem_categories | –†–µ–π—Ç–∏–Ω–≥ –ø–æ 90-–º—É –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—é –≤—Ä–µ–º–µ–Ω–∏ —Ä–µ–∞–∫—Ü–∏–∏ |
| –ß–∞—Å—ã —Å—É—Ç–æ–∫, –Ω–∞—Ä—É—à–µ–Ω–∏—è —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∞ | analyze_hourly_violations | –ü–æ—á–∞—Å–æ–≤–æ–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–≤–∞–ª–æ–≤ |
| –î–Ω–∏ –Ω–µ–¥–µ–ª–∏, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ | analyze_contractor_discipline_weekly | –ê–Ω–∞–ª–∏–∑ –≤—ã—Ö–æ–¥–Ω—ã—Ö vs –±—É–¥–Ω–µ–π |
| –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–ø–µ—Ü—Ç–µ—Ö–Ω–∏–∫–∏ | analyze_machinery_efficiency | –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö –≤—ã–µ–∑–¥–æ–≤ |
| –í–ª–∏—è–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–∏ –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å | analyze_cleaning_impact_on_traffic | –ê–Ω–∞–ª–∏–∑ –î–æ/–ü–æ—Å–ª–µ |
| –ü—Ä–æ–±–µ–ª—ã –≤ –¥–∞–Ω–Ω—ã—Ö –∫–∞–º–µ—Ä | monitor_camera_data_quality | –¢–æ–ø-20 –∫–∞–º–µ—Ä —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏ |
| –ü–æ–≥–æ–¥–∞ –∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è SLA | analyze_sla_weather_dependency | –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –æ—Å–∞–¥–∫–æ–≤ –∏ –Ω–∞—Ä—É—à–µ–Ω–∏–π |

## –ò–ù–°–¢–†–£–ö–¶–ò–ò

1. –ï—Å–ª–∏ –≤–∏–¥–∏—à—å —Ç–µ–≥ [–ò–°–ü–û–õ–¨–ó–£–ô: –∏–º—è_–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞] ‚Äî –ù–ï–ú–ï–î–õ–ï–ù–ù–û –≤—ã–∑–æ–≤–∏ —É–∫–∞–∑–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤. 
   + –ü–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ—Å—Ç—Ä–æ–π –≥—Ä–∞—Ñ–∏–∫ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ, —Ç–æ –º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ) –∏–∑ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
2. –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏—Ö –∏ –¥–∞–π —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –≤—ã–≤–æ–¥–∞–º–∏.
3. –í—ã–¥–µ–ª—è–π –∫–ª—é—á–µ–≤—ã–µ —Ü–∏—Ñ—Ä—ã –∏ —Ç—Ä–µ–Ω–¥—ã.
4. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–∑–≤–æ–ª—è—é—Ç ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ —Å –ø–æ–º–æ—â—å—é create_plot.
5. –î–ª—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö SQL –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π execute_sql_select.`,
        messages: await convertToModelMessages(messages),
        tools,
        toolChoice: "auto", // –∏–ª–∏ 'auto', –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –≤–∫–ª—é—á–∏—Ç—å –≤—ã–∑–æ–≤—ã
        stopWhen: stepCountIs(10),
    });

    return result.toUIMessageStreamResponse();
}
